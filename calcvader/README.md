# 電卓インベーダー (CALCVADER)

CASIO SL-880「ゲーム電卓」のインベーダーゲームを再現したArduinoゲームです。

## 元になったゲーム電卓について

CASIO SL-880は、1980年8月に発売された「MG880」を38年ぶりに復刻したモデルで、2018年3月23日に発売されました。右側から攻め込んでくるデジタルインベーダー（数字）を、自陣の数字と合わせて撃ち落とすゲームが搭載されています。

## ゲームの仕様

### 基本ルール

- **インベーダーの数**:
  - 1ラウンド中に襲来するデジタルインベーダーの総数: **16個**
  - パート1: 右端（6桁目）から登場、画面上には最大6個まで同時表示
  - パート2: 右から2桁目（5桁目）から登場、画面上には最大5個まで同時表示（より難易度が高い）
- **クリア条件**: 16個すべてのインベーダーを撃破するとラウンドクリア
- **ゲームオーバー条件**:
  - ライフがなくなる（砲台が3回やられる）
  - 1ラウンド内で「FIRE」を30回押す（弾切れ）
- **ステージ構成**:
  - パート1: パターン1～9
  - パート2: パターン1～9
  - パート2のパターン9をクリアすると、再びパート1のパターン1に戻る（無限ループ）

### 操作方法

オリジナルのゲーム電卓では以下の2つのキーで操作します：

1. **AIMキー（小数点キー）**: 照準の数字を変更
   - 押すたびに画面左に表示されている照準が 0, 1, 2, ..., 9, n, 0... と繰り上がる
   - 照準の数字をインベーダーの数字に合わせる
   - 照準「n」でUFO（n）を狙う

2. **FIREキー（＋キー）**: 発射
   - 照準を合わせた後に押すと、そのインベーダーを撃破できる
   - UFO（n）が出現している時は、照準を「n」に合わせてFIREで撃破

### ゲームシステム

- **インベーダーの動き**: デジタル表示上で数字として表現され、右から左へ移動
- **砲台（自陣）の表現**:
  - 砲台は照準数字の右隣に7セグメント風の文字として表示される
  - 残機の表示方法（7セグメントディスプレイの表現）:
    - 残機3: **E**（横棒3本: 上・中・下）
    - 残機2: **=**（横棒2本: 中・下）
    - 残機1: **-**（横棒1本: 中のみ）
    - 残機0: 何も表示されない（ゲームオーバー）
  - インベーダーが左端に到達すると砲台が攻撃され、表示が変化: E → = → - → (なし)
- **照準システム**: 画面左に表示される数字をインベーダーの数字に合わせて撃破
- **難易度**:
  - パート1: 6個のインベーダーが右端から登場
  - パート2: 5個のインベーダーが右から2桁目から登場（より左側からスタートするため難易度が高い）
  - パターンが進むにつれてインベーダーの速度が増加
- **弾数制限**: 1ラウンドあたり最大30発まで

### UFO（n）の出現

特別なボーナス要素として「UFO（n）」が出現します：

- **出現条件**: ラウンドの開始から消した数字の和が10の倍数になると出現
  - 例: 3, 4, 5 を撃破（合計12）→ 次に 8 を撃破（合計20）→ UFO出現
- **表示**: インベーダーの列に「n」として表示される
- **ボーナス**: UFOを撃ち落とすと **300点** が加算される
- **照準**: UFOを狙う場合、照準を「n」に合わせてFIREキーを押す

### 得点システム

得点はインベーダーを撃破した**位置**によって決まります。素早く撃破するほど高得点！

#### パート1の得点

| 位置 | 得点 |
|------|------|
| 砲台手前（1桁目） | 10点 |
| 2桁目 | 20点 |
| 3桁目 | 30点 |
| 4桁目 | 40点 |
| 5桁目 | 50点 |
| 6桁目（出現位置） | 60点 |

#### パート2の得点（パート1の2倍）

パート2では得点が2倍になります！

| 位置 | 得点 |
|------|------|
| 砲台手前（1桁目） | **20点** |
| 2桁目 | **40点** |
| 3桁目 | **60点** |
| 4桁目 | **80点** |
| 5桁目（出現位置） | **100点** |

※パート2は右から2桁目から出現するため、最大5個のインベーダー

#### その他の得点

- **UFO（n）撃破**: **300点ボーナス**（パート1・2共通）
- **ラウンドクリアボーナス**: ラウンドをクリアすると追加得点
- **残弾ボーナス**: 弾を余らせてクリアするとボーナス

つまり、右端（出現位置）で撃破すれば高得点、左端（砲台手前）まで来てしまうと低得点になります。
素早い撃破が高得点の鍵です！

## Arduino版の実装

このArduino版では、OLED ディスプレイとボタンを使って以下のように実装します：

### ハードウェア構成

- **ディスプレイ**: 128x64 OLED (SSD1306)
- **ボタン**: 2つ（AIMボタン: ピン5、FIREボタン: ピン6）

### 画面レイアウト

実機の画面構成を参考にしたレイアウト：

```
┌─────────────────────────┐
│                         │
│                         │
│   8  E  96n154          │
│         ↑               │
│      インベーダー        │
│   ↑  ↑   (UFO含む)      │
│ 照準 残機                │
│                         │
│ SUM: 0  AMMO: 30        │
└─────────────────────────┘
```

画面要素の配置：

- **左端**: 照準数字を大きく表示
  - 0～9、nの11種類を表示
  - UFO狙いの時は「n」
  - 7セグメント風に大きく表示
- **照準の右隣**: 残機を7セグメント風の文字で表示
  - 残機は照準数字の隣に1文字で配置
  - 残機3: **E**（横棒3本を表現）
  - 残機2: **=**（横棒2本を表現）
  - 残機1: **-**（横棒1本を表現）
  - 残機0: 何も表示されない（スペース）
- **右側中央**: デジタルインベーダー（数字の列）
  - パート1: 画面上に最大6個同時表示（右端から登場）
  - パート2: 画面上に最大5個同時表示（右から2桁目から登場）
  - 1ラウンドで合計16個のインベーダーが次々と襲来
  - 撃破されたり画面外に出たインベーダーは、新しいインベーダーに置き換わる
  - 0～9の数字が右から左へ移動
  - UFO（n）もこの列に混在して出現
  - 例: パート1は `96n154` のように6個表示（UFO含む）
- **下部左**: 撃破した数字の合計（SUM）
- **下部右**: 残弾数（AMMO）

### 7セグメント風の表示

実機は7セグメント電卓表示を使用しているため、以下のような表示になります：

```
残機3の状態（パート1）：
  8  E  765n14
        ↑
     インベーダー（6個）
  ↑  ↑
照準 残機E（横棒3本）

残機2の状態：
  3  =  814529
        ↑
     インベーダー（6個）
  ↑  ↑
照準 残機=（横棒2本）

残機1の状態：
  n  -  n6235
        ↑
     UFO出現中（5個）
  ↑  ↑
照準n 残機-（横棒1本）

残機0（ゲームオーバー）：
  5     8523
        ↑
     インベーダー（4個）
  ↑  ↑
照準 残機なし

パート2の例（右から2桁目から登場）：
  5  E   81n54
         ↑
     5個のインベーダー
     （より左からスタート）

画面配置のイメージ：
┌────────────────┐
│ 照準 残機 インベーダー列 │
│  8   E   96n154    │
│                    │
└────────────────┘

ダメージを受けた際の変化：
  8  E  → 8  =  → 8  -  → 8
  ↓       ↓       ↓       ↓
残機3   残機2   残機1   残機0
```

### ゲームフロー

1. **タイトル画面**: ゲームタイトルとスタート待機
   - FIREボタンでゲーム開始
2. **ゲーム開始**: パート1のパターン1から開始
3. **ゲームプレイ**:
   - AIMボタンで照準変更（0→1→2...→9→n→0...とループ）
   - 照準を画面左端に表示
   - FIREボタンで発射
   - 照準とインベーダーの数字が一致していれば撃破成功
   - **インベーダーの右詰め**: インベーダーを撃破すると、そのインベーダーより左にいたインベーダーが右に詰められる（例: `1121`で`2`を撃破→`111`）
   - 照準が「n」のときにUFO（n）を狙える
   - 撃破した数字の合計（SUM）を追跡
   - SUMが10の倍数になるとUFO（n）が出現
   - UFOを撃破すると300点ボーナス
   - インベーダーが左端（砲台の位置）に到達すると砲台が攻撃される
   - 砲台が攻撃されると残機表示が変化: E → = → - → (なし)
   - インベーダーが左端に到達した場合もカウントされ、16個処理でラウンドクリア
4. **ラウンドクリア**: 16個すべてのインベーダーを処理（撃破または左端到達）で次のパターンへ
   - 「ROUND CLEAR!」メッセージ表示
   - 2秒のインターバル
   - SUMとAMMOがリセット
   - パート1のパターン1～9をクリア後、パート2のパターン1へ
   - パート2のパターン1～9をクリア後、パート1のパターン1へ戻る（無限ループ）
5. **ゲームオーバー**: 砲台が0になる（ライフが0）または弾切れ
   - 「GAME OVER」メッセージとスコア表示
   - 両方のボタンを同時押しでタイトル画面に戻る
6. **速度調整**:
   - パターン1: 1500ms間隔（1.5秒）でインベーダーが移動
   - パターンが進むにつれて100msずつ速くなる
   - 最速: 600ms間隔

### 実装の注意点

- **インベーダーの出現と管理**:
  - 1ラウンドで合計16個のインベーダーが襲来
  - パート1: 画面上には最大6個まで同時表示（右端から登場）
  - パート2: 画面上には最大5個まで同時表示（右から2桁目から登場）
  - 撃破または画面左端到達で消えたインベーダーは、16個に達するまで新しいものと入れ替わる
  - **右詰め処理**: インベーダーを撃破すると、そのインベーダーより左にいるインベーダーが右に詰められる
    - 撃破されたインベーダーの`position`より小さい`position`を持つインベーダーの`position`を1増やす
    - X座標も12ピクセル右に移動
- インベーダーは右から左へ徐々に移動
- パターンが進むにつれてインベーダーの速度が増加
- **ゲームループ**: パート1（パターン1～9）→ パート2（パターン1～9）→ パート1へ戻る
- **画面配置（左から順に）**:
  1. **照準数字**: 7セグメント風に大きく表示（0～9、n の11種類）
  2. **残機表示**: 照準の右隣に1文字で表示
     - 残機3: **E**（横棒3本を表現）
     - 残機2: **=**（横棒2本を表現）
     - 残機1: **-**（横棒1本を表現）
     - 残機0: 何も表示されない（ゲームオーバー）
  3. **インベーダー列**: 残機表示の右側に数字の列を表示（常に右詰めで表示）
- **照準の表示**:
  - 照準システムは数字のループで実装（0→1→2...→9→n→0...）
  - 照準「n」でUFO（n）を狙う
- **得点計算**:
  - インベーダーの位置（桁数）に応じた得点
  - パート1: 位置 × 10点（例: 6桁目 = 60点、1桁目 = 10点）
  - パート2: 位置 × 20点（例: 5桁目 = 100点、1桁目 = 20点）
  - UFO撃破で300点ボーナス
- **配列管理**:
  - `compactInvaders()`: インベーダーが撃破されたら配列を詰める
  - `shiftInvadersRight()`: 撃破されたインベーダーより左にいるインベーダーを右に詰める
  - 配列を詰めた後、空きスロットは明示的にクリア
- SUMの計算：撃破した数字を加算し、10の倍数チェック
- UFO（n）は通常のインベーダーの列に混在して出現
- UFO出現中は通常のインベーダーも動き続ける
- インベーダーが左端に到達したら砲台が攻撃され、`invadersDefeated`もカウント
- メモリ制限を考慮し、配列サイズを最小限に

### データ構造の例

```cpp
// インベーダー管理
struct Invader {
  int number;        // 数字（0-9、'n'はUFOを示す特別な値）
  int position;      // 位置（1～6の桁数、得点計算に使用）
  int x, y;          // 座標
  bool active;       // 生存フラグ
  bool isUFO;        // UFOフラグ
};

const int MAX_VISIBLE_PART1 = 6;  // パート1: 画面上に最大6個
const int MAX_VISIBLE_PART2 = 5;  // パート2: 画面上に最大5個
const int TOTAL_INVADERS_PER_ROUND = 16;  // 1ラウンドあたり16個

Invader invaders[6];   // 画面上に表示される最大6個のインベーダー

// ゲーム状態
int aim = 0;           // 照準（0-9, n の11種類、nは10で表現）
int sum = 0;           // 撃破した数字の合計
bool ufoActive = false; // UFO出現フラグ
int ufoIndex = -1;     // UFOのインデックス（どのインベーダーがUFOか）
int score = 0;
int life = 3;          // ライフ（砲台の矢印の数）
int ammo = 30;
int pattern = 1;       // 現在のパターン（1～9）
int part = 1;          // 現在のパート（1 or 2）
int invadersDefeated = 0;  // 撃破したインベーダー数（ラウンドごとにカウント、16個でクリア）
int invadersSpawned = 0;   // 出現したインベーダー数（16個まで）

// 得点計算関数
int calculateScore(int position, int part) {
  // パート1: 位置 × 10点
  // パート2: 位置 × 20点（2倍）
  int multiplier = (part == 1) ? 10 : 20;
  return position * multiplier;
}
```

## オリジナルとの違い

- オリジナルは電卓の7セグメントディスプレイで表示
- Arduino版はOLEDディスプレイでより視覚的に表現可能
- グラフィックスの自由度が高いため、よりゲームらしい演出が可能
- UFO（n）の視覚的な表現を工夫できる

## 参考リンク

- [CASIO SL-880 公式ページ](https://www.casio.com/jp/basic-calculators/product.SL-880/)
- [価格.comマガジン レビュー記事](https://kakakumag.com/houseware/?id=11983)
